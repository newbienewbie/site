<!--
index: 6
title: 自定义图例交互
-->

<script>
  const { Util, G } = F2;
  const { Group } = G;
  function drawLabel(shape, coord, canvas) {
    const { center } = coord;
    const origin = shape.get('origin');
    const points = origin.points;
    const x1 = (points[2].x - points[1].x) * 0.75 + points[1].x;
    const x2 = (points[2].x - points[1].x) * 1.8 + points[1].x;
    const y = (points[0].y + points[1].y) / 2;
    const point1 = coord.convertPoint({ x: x1, y });
    const point2 = coord.convertPoint({ x: x2, y });

    const group = new Group();
    group.addShape('Line', {
      attrs: {
        x1: point1.x,
        y1: point1.y,
        x2: point2.x,
        y2: point2.y,
        lineDash: [ 0, 2, 2 ],
        stroke: '#808080'
      }
    });
    const text = group.addShape('Text', {
      attrs: {
        x: point2.x,
        y: point2.y,
        text: origin._origin.name + '  ' + origin._origin.proportion * 100 + '%',
        fill: '#808080',
        textAlign: 'start',
        textBaseline: 'bottom'
      }
    });
    const textWidth = text.getBBox().width;
    const baseLine = group.addShape('Line', {
      attrs: {
        x1: point2.x,
        y1: point2.y,
        x2: point2.x,
        y2: point2.y,
        stroke: '#808080'
      }
    });
    if (point2.x > center.x) {
      baseLine.attr('x2', point2.x + textWidth);
    } else if (point2.x < center.x) {
      text.attr('textAlign', 'end');
      baseLine.attr('x2', point2.x - textWidth);
    } else {
      text.attr('textAlign', 'center');
      text.attr('textBaseline', 'top');
    }
    canvas.add(group);
    shape.label = group;
  }

  const data = [
    { name: '芳华', proportion: 0.4, a: '1' },
    { name: '妖猫传', proportion: 0.2, a: '1' },
    { name: '机器之血', proportion: 0.18, a: '1' },
    { name: '心理罪', proportion: 0.15, a: '1' },
    { name: '寻梦环游记', proportion: 0.05, a: '1' },
    { name: '其他', proportion: 0.02, a: '1' }
  ];
  const chart = new F2.Chart({
    id: 'mountNode',
    width: window.innerWidth,
    height: window.innerWidth * 0.707,
    pixelRatio: window.devicePixelRatio
  });
  chart.source(data);
  let lastClickedShape;
  chart.legend({
    position: 'bottom',
    offsetY: 15,
    marker: 'square',
    align: 'center',
    onClick(ev) {
      const { clickedItem } = ev;
      const dataValue = clickedItem.get('dataValue');
      const canvas = chart.get('canvas');
      const coord = chart.get('coord');
      const geom = chart.get('geoms')[0];
      const container = geom.get('container');
      const shapes = geom.get('shapes'); // 只有带精细动画的 geom 才有 shapes 这个属性

      let clickedShape;
      // 找到被点击的 shape
      Util.each(shapes, shape => {
        const origin = shape.get('origin');
        if (origin && origin._origin.name === dataValue) {
          clickedShape = shape;
          return false;
        }
      });

      if (lastClickedShape) {
          lastClickedShape.animate().to({
            attrs: {
              lineWidth: 0
            },
            duration: 200
          }).onStart(() => {
            if (lastClickedShape.label) {
              lastClickedShape.label.hide();
            }
          }).onEnd(() => {
            lastClickedShape.set('selected', false);
          });
        }

      if (clickedShape.get('selected')) {
        clickedShape.animate().to({
          attrs: {
            lineWidth: 0
          },
          duration: 200
        }).onStart(() => {
          if (clickedShape.label) {
            clickedShape.label.hide();
          }
        }).onEnd(() => {
          clickedShape.set('selected', false);
        });
      } else {
        const color = clickedShape.attr('fill');
        clickedShape.animate().to({
          attrs: {
            lineWidth: 8
          },
          duration: 350,
          easing: 'bounceOut'
        }).onStart(() => {
          clickedShape.attr('stroke', color);
          clickedShape.set('zIndex', 1);
          container.sort();
        }).onEnd(() => {
          clickedShape.set('selected', true);
          clickedShape.set('zIndex', 0);
          container.sort();
          lastClickedShape = clickedShape;
          if (clickedShape.label) {
            clickedShape.label.show();
          } else {
            drawLabel(clickedShape, coord, canvas);
          }
        });
      }
    }
  });
  chart.coord('polar', {
    transposed: true,
    innerRadius: 0.7,
    radius: 0.8
  });
  chart.axis(false);
  chart.interval()
    .position('a*proportion')
    .color('name', [ '#1890FF', '#13C2C2', '#2FC25B', '#FACC14', '#F04864', '#8543E0' ])
    .adjust('stack');
  chart.render();
</script>
