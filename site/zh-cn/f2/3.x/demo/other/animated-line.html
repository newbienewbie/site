<!--
index: 8
title: 时序动画
resource:
  jsFiles:
    - ${url.jquery}
-->

<style type="text/css">
.btn {
    display: inline-block;
    font-weight: 400;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    border: 1px solid transparent;
    padding: .25rem .75rem;
    font-size: .5rem;
    line-height: 1.25;
    border-radius: .25rem;
    transition: all .15s ease-in-out;
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
}
.btn.focus, .btn:focus {
    outline: 0;
    box-shadow: 0 0 0 1px rgba(0,123,255,.25);
}
.btn:focus, .btn:hover {
    text-decoration: none;
}
</style>

<script>
  $(`<div>
    <button class="btn" id='one'>近 1 月</button>
    <button class="btn" id='three'>近 3 月</button>
    <button class="btn" id='six'>近 6 月</button>
    <button class="btn" id='oneYear'>近 1 年</button>
  </div>`).insertBefore('#mountNode');

  const G = F2.G;

  let data;
  let oneMonth;
  let threeMonth;
  let sixMonth;
  let oneYear;
  let chart;

  $('#one').click(() => {
    const one = data.slice(oneMonth);
    chart.changeData(one);
  });

  $('#three').click(() => {
    const three  = data.slice(threeMonth);
    chart.changeData(three);
  });

  $('#six').click(() => {
    const six  = data.slice(sixMonth);
    chart.changeData(six);
  });

  $('#oneYear').click(() => {
    const six  = data.slice(oneYear);
    chart.changeData(six);
  });

  F2.Animate.registerAnimation('lineUpdate', function(updateShape, animateCfg, coord) {
    const cacheAttrs = updateShape.get('cacheShape').attrs;
    const attrs = updateShape.attr();
    const points = attrs.points;
    const partA = points.slice(0, cacheAttrs.points.length);
    const partB = points.slice(cacheAttrs.points.length);
    points.map((point, index) => {
      if (index <= cacheAttrs.points.length - 1) {
        partB.unshift({});
      } else {
        partA.push({});
      }
    });
    updateShape.attr(cacheAttrs);
    const clip = new G.Shape.Rect({
      attrs: {
        x: cacheAttrs.points[cacheAttrs.points.length - 1].x,
        y: cacheAttrs.points[cacheAttrs.points.length - 1].y,
        width: 0,
        height: Math.abs(coord.end.y - coord.start.y)
      }
    });
    clip.set('canvas', updateShape.get('canvas'));

    updateShape.animate().to({
      attrs: {
        points: partA
      },
      duration: 300,
      easing: animateCfg.easing
    }).onEnd(function() {
      updateShape.set('cacheShape', null);
      updateShape.attr('points', points);
      updateShape.get('canvas').draw();
    });
  });


  $.getJSON('/assets/data/f2-animted-line.json', json => {
    const source = [];
    let i = 0;
    json.map(obj => {
        i++;
        if (obj.reportDate === "2018-01-02") {
          oneMonth = i;
        } else if (obj.reportDate === "2017-11-01") {
          threeMonth = i;
        } else if (obj.reportDate === "2017-08-01") {
          sixMonth = i;
        } else if (obj.reportDate === "2017-01-03") {
          oneYear = i;
        }
        obj.value = obj.value * 1;
        source.push(obj);
    });
    data = source;
    chart = new F2.Chart({
      id: 'mountNode',
      pixelRatio: window.devicePixelRatio
    });

    chart.source(data.slice(oneMonth), {
      reportDateTimestamp: {
        type: 'timeCat'
      }
    });
    chart.axis('reportDateTimestamp', {
      label(text, index, total) {
        const cfg = {
          textAlign: 'center'
        };
        // 第一个点左对齐，最后一个点右对齐，其余居中，只有一个点时左对齐
        if (index === 0) {
          cfg.textAlign = 'start';
        }
        if (index > 0 && index === total - 1) {
          cfg.textAlign = 'end';
        }
        return cfg;
      }
    });

    chart.line({
      sortable: false
    }).position('reportDateTimestamp*value')
      .animate({
        update: {
          animation: 'lineUpdate'
        }
      });
    chart.render();
  });
</script>
